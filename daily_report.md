# 業務日報

---

## 2025年7月31日

### 本日発生した問題と解決策

*   **発生した問題:** Streamlitアプリケーションで「選択した日に運行するサービスはありません」と表示される問題。
*   **原因:** アプリケーション実行時のカレントディレクトリが想定と異なっていたため、データファイル（GTFS）の相対パス解決に失敗していた。
*   **解決策:** `pathlib`を使用して、スクリプト自身のパスを基準にデータファイルへの絶対パスを構築するように修正した。
*   **学んだこと:** 相対パスは実行場所に依存するため、特にスクリプトやアプリケーションでは、ファイルの場所を基準にしたパス指定が重要であること。

---

## 2025年7月29日

### プロジェクト
Ehime Bus Time-Lapse Theater

### 本日の作業内容

1.  **`task.md` および `yoken.md` の文字化け修正**
    *   提供された文字化けしたファイルを統合し、正しい日本語で整形。
    *   進捗状況を反映し、最新の状態に更新。

2.  **GTFSデータ読み込みとキャッシュ生成のデバッグ**
    *   `KeyError: 'route_id'` の原因調査と修正。
        *   `path_builder.py` が `route_id` を含むデータを生成するよう修正。
        *   `app.py` が `routes.txt` から `route_id` を文字列として読み込むよう修正。
        *   キャッシュのクリアと再生成を複数回実施し、問題の切り分け。
    *   `service_filter.py` の日付フィルタリングロジックのデバッグ。
        *   `calendar.txt` の日付範囲と曜日フラグの確認。
        *   `path_builder.py` が `service_filter.py` に正しい `gtfs_dir` を渡していることを確認。
    *   `build_day_cache` が空のデータフレームを返す問題の調査。
        *   `stop_coords` の初期化ロジックの修正。
        *   各処理段階でのデータ行数をデバッグプリントで追跡。

3.  **Streamlit UI の改善と自動再生機能の強化**
    *   地図が表示されない問題の解決。
        *   Mapbox APIキーの依存を排除し、OpenStreetMapベースのタイル（CartoDB）を使用するよう変更。
    *   時刻表示の改善。
        *   スライダーの秒表示を「HH:MM:SS」形式に変更。
    *   自動再生の不具合修正と高速化。
        *   `st.session_state` を利用して時刻を保持し、`st.rerun()` でアニメーションを継続。
        *   `time.sleep()` の値を短縮し、タイムラプス再生を高速化。
        *   自動再生をデフォルトで有効化。
    *   路線選択機能の追加。
        *   サイドバーに路線選択のマルチセレクトボックスを追加。
        *   選択された路線のみをフィルタリングして表示。
        *   「決定」ボタンを追加し、選択の反映を明示化。
        *   デフォルト選択路線を「松山空港（道後温泉）」に設定。

### 課題と次回の作業予定

*   **課題**:
    *   自動再生が途中で止まる問題（`st.rerun()`によるアニメーションの継続）は解決済みか、最終確認が必要。
    *   `@st.cache_data`によるキャッシュが原因で、空のデータがキャッシュされる問題の再発防止策の検討。
*   **次回の作業予定**:
    *   自動再生機能の最終確認と安定化。
    *   日付選択機能の再実装（GTFSデータ範囲の表示とデフォルト日付の設定）。
    *   パフォーマンスの最適化（必要であれば）。
    *   要件定義書（`yoken.md`）とタスクリスト（`task.md`）の最終レビューと確定。

### 自己評価
本日は多くのデバッグと機能改善を行い、バスの軌跡が地図上に描画されるようになりました。特に、GTFSデータの読み込み、フィルタリング、そしてStreamlitの描画サイクルとの連携における複雑な問題を解決できたことは大きな進展です。自動再生の安定化と日付選択機能の再実装が次なる重要なステップです。

---

## 2025年8月19日

### プロジェクト
Ehime Bus Time-Lapse Theater

### 本日の作業内容

1.  **アニメーション表示の抜本的改善とパフォーマンス最適化**
    *   Python側での毎フレーム再描画ループを廃止し、JavaScript（deck.gl）側でアニメーションを制御するアーキテクチャへ移行。
    *   データ転送量削減のため、以下の前処理を導入：
        *   時間間引き (`thin_by_time`)
        *   近傍重複削除 (`drop_near_duplicates`)
        *   座標量子化
    *   `string.Template` を使用し、Pythonのf-stringとJavaScriptの波括弧の衝突によるSyntaxErrorを解消。
    *   `deck.gl` のレイヤーが不変である特性に対応し、毎フレーム新しいレイヤーインスタンスを生成して更新する方式に修正。

2.  **複数路線同時表示機能の拡張**
    *   ルートごとの色付けを導入し、各tripデータに`route_id`と`color`を埋め込み。
    *   JavaScript側でルートフィルタリングUI（凡例パネル、検索ボックス、全ON/OFFボタン）を実装。
    *   Streamlitサイドバーの路線選択`multiselect`に「全て選択 / 全て解除 / 反転」ボタンを追加し、`st.session_state`で選択状態を管理。

### 課題と次回の作業予定

*   **課題**:
    *   現在のパフォーマンスがユーザーの期待を満たしているか最終確認。
    *   `@st.cache_data(persist=True)` の互換性に関する警告の有無と対応。
*   **次回の作業予定**:
    *   ユーザーからのフィードバックに基づき、さらなる改善や機能追加。
    *   ドキュメント（`README.md`、アーキテクチャ図など）の更新。

### 自己評価
本日は、アプリケーションの核となるアニメーション表示のパフォーマンスを劇的に改善し、複数路線同時表示という重要な機能拡張を実現しました。特に、PythonとJavaScript間の連携における複雑な問題を解決し、ユーザー体験を大きく向上させることができた点は大きな成果です。